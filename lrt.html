<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Closest LRT Stations</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, button { padding: 10px; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    td, th { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h2>Find the 3 Closest LRT Stations</h2>
  <input id="addressInput" type="text" placeholder="Enter your address" size="50">
  <button onclick="findClosestStations()">Calculate</button>
  <div id="results"></div>

  <script>
    const lrtStations = [
      { name: "Bayview", lat: 45.4115, lng: -75.7181 },
      { name: "Lyon", lat: 45.4162, lng: -75.7073 },
      { name: "Parliament", lat: 45.4203, lng: -75.7006 },
      { name: "Rideau", lat: 45.4260, lng: -75.6870 },
      { name: "uOttawa", lat: 45.4244, lng: -75.6831 }
    ];

    async function geocodeAddress(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const response = await fetch(url);
      const data = await response.json();
      if (!data.length) throw new Error("Address not found.");
      return {
        lat: data[0].lat,
        lng: data[0].lon
      };
    }

    async function getDistances(origin, destinations, mode) {
      const response = await fetch("/.netlify/functions/get-distance", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          origins: `${origin.lat},${origin.lng}`,
          destinations: destinations.map(d => `${d.lat},${d.lng}`).join("|"),
          mode
        })
      });

      const data = await response.json();
      console.log("Distance Matrix API response:", data); // ðŸ” log here
      return data.rows[0].elements;
    }

    async function findClosestStations() {
      const address = document.getElementById("addressInput").value;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "Loading...";

      try {
        const origin = await geocodeAddress(address);
        const walking = await getDistances(origin, lrtStations, "walking");
        const driving = await getDistances(origin, lrtStations, "driving");

        const combined = lrtStations.map((station, i) => ({
          name: station.name,
          walkText: walking[i].distance.text,
          walkValue: walking[i].distance.value,
          driveText: driving[i].distance.text
        }));

        combined.sort((a, b) => a.walkValue - b.walkValue);
        const top3 = combined.slice(0, 3);

        let html = `<h3>Closest LRT Stations</h3><table><tr><th>Station</th><th>Walking Distance</th><th>Driving Distance</th></tr>`;
        top3.forEach(station => {
          html += `<tr><td>${station.name}</td><td>${station.walkText}</td><td>${station.driveText}</td></tr>`;
        });
        html += `</table>`;
        resultsDiv.innerHTML = html;

      } catch (err) {
        resultsDiv.innerHTML = `<span style="color:red;">Error: ${err.message}</span>`;
      }
    }
  </script>
</body>
</html>
