<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Closest LRT Stations</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, button { padding: 10px; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    td, th { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h2>Find the 3 Closest LRT Stations</h2>
  <input id="addressInput" type="text" placeholder="Enter your address" size="50">
  <button onclick="findClosestStations()">Calculate</button>
  <div id="results"></div>

  <script>
    const lrtStations = [
        { name: "Tunney's Pasture", lat: 45.4218, lng: -75.7106 },
        { name: "Bayview", lat: 45.4115, lng: -75.7181 },
        { name: "Pimisi", lat: 45.4148, lng: -75.7102 },
        { name: "Lyon", lat: 45.4186, lng: -75.7051 },
        { name: "Parliament", lat: 45.4203, lng: -75.7006 },
        { name: "Rideau", lat: 45.4260, lng: -75.6870 },
        { name: "uOttawa", lat: 45.4244, lng: -75.6831 },
        { name: "Lees", lat: 45.4298, lng: -75.6761 },
        { name: "Hurdman", lat: 45.4298, lng: -75.6517 },
        { name: "Tremblay", lat: 45.4271, lng: -75.6380 },
        { name: "Stâ€‘Laurent", lat: 45.4333, lng: -75.5876 },
        { name: "Cyrville", lat: 45.4348, lng: -75.5479 },
        { name: "Blair", lat: 45.4318, lng: -75.4790 },
        { name: "Carleton", lat: 45.3870, lng: -75.6965 },
        { name: "Mooney's Bay", lat: 45.3740, lng: -75.6920 },
        { name: "Brookfield", lat: 45.3622, lng: -75.6700 },
        { name: "Corktown", lat: 45.3487, lng: -75.6539 },
        { name: "Greenboro", lat: 45.3272, lng: -75.6478 },
        { name: "South Keys", lat: 45.3054, lng: -75.6361 },
        { name: "Leitrim", lat: 45.2750, lng: -75.6390 },
        { name: "Bowesville", lat: 45.2400, lng: -75.6470 },
        { name: "Limebank", lat: 45.2000, lng: -75.6500 },
        { name: "Uplands", lat: 45.3290, lng: -75.6250 },
        { name: "Airport", lat: 45.3333, lng: -75.6319 }
    ];
 
    async function geocodeAddress(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const response = await fetch(url);
      const data = await response.json();
      if (!data.length) throw new Error("Address not found.");
      return {
        lat: data[0].lat,
        lng: data[0].lon
      };
    }

    async function getDistances(origin, destinations, mode) {
      const response = await fetch("/.netlify/functions/get-distance", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          origins: `${origin.lat},${origin.lng}`,
          destinations: destinations.map(d => `${d.lat},${d.lng}`).join("|"),
          mode
        })
      });

      const data = await response.json();
      console.log("Distance Matrix API response:", data); // ðŸ” log here
      return data.rows[0].elements;
    }

    async function findClosestStations() {
      const address = document.getElementById("addressInput").value;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "Loading...";

      try {
        const origin = await geocodeAddress(address);
        const walking = await getDistances(origin, lrtStations, "walking");
        const driving = await getDistances(origin, lrtStations, "driving");
        const cycling = await getDistances(origin, lrtStations, "bicycling");

        const combined = lrtStations.map((station, i) => ({
            name: station.name,
            walkText: `${walking[i].distance.text} (${walking[i].duration.text})`,
            walkValue: walking[i].distance.value,
            driveText: `${driving[i].distance.text} (${driving[i].duration.text})`,
            cycleText: `${cycling[i].distance.text} (${cycling[i].duration.text})`
        }));

        combined.sort((a, b) => a.walkValue - b.walkValue);
        const top3 = combined.slice(0, 3);

        let html = `<h3>Closest LRT Stations</h3><table>
                    <tr>
                        <th>Station</th>
                        <th>Walking</th>
                        <th>Driving</th>
                        <th>Cycling</th>
                    </tr>`;
        top3.forEach(station => {
            html += `<tr>
                <td>${station.name}</td>
                <td>${station.walkText}</td>
                <td>${station.driveText}</td>
                <td>${station.cycleText}</td>
            </tr>`;
        });
        html += `</table>`;
        resultsDiv.innerHTML = html;

      } catch (err) {
        resultsDiv.innerHTML = `<span style="color:red;">Error: ${err.message}</span>`;
      }
    }
  </script>
</body>
</html>
